<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue-router 第四篇</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/my-blog/favicon.ico">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.5d6174b8.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.32be202e.js" as="script"><link rel="preload" href="/my-blog/assets/js/3.a0eaa787.js" as="script"><link rel="preload" href="/my-blog/assets/js/1.f46f4f66.js" as="script"><link rel="preload" href="/my-blog/assets/js/80.5d5f4b1e.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.d6af31bc.js"><link rel="prefetch" href="/my-blog/assets/js/100.27c20759.js"><link rel="prefetch" href="/my-blog/assets/js/101.cddb3339.js"><link rel="prefetch" href="/my-blog/assets/js/11.26feaf4f.js"><link rel="prefetch" href="/my-blog/assets/js/12.73c5de2a.js"><link rel="prefetch" href="/my-blog/assets/js/13.cea3cbf2.js"><link rel="prefetch" href="/my-blog/assets/js/14.47539c67.js"><link rel="prefetch" href="/my-blog/assets/js/15.25455bcd.js"><link rel="prefetch" href="/my-blog/assets/js/16.81dc735f.js"><link rel="prefetch" href="/my-blog/assets/js/17.3fa23e44.js"><link rel="prefetch" href="/my-blog/assets/js/18.bea49075.js"><link rel="prefetch" href="/my-blog/assets/js/19.0002a8d7.js"><link rel="prefetch" href="/my-blog/assets/js/20.fcc72e3d.js"><link rel="prefetch" href="/my-blog/assets/js/21.a1f59723.js"><link rel="prefetch" href="/my-blog/assets/js/22.de87bf53.js"><link rel="prefetch" href="/my-blog/assets/js/23.8cd9339b.js"><link rel="prefetch" href="/my-blog/assets/js/24.3db14a3d.js"><link rel="prefetch" href="/my-blog/assets/js/25.744fa5db.js"><link rel="prefetch" href="/my-blog/assets/js/26.3e0e53c0.js"><link rel="prefetch" href="/my-blog/assets/js/27.b6f44027.js"><link rel="prefetch" href="/my-blog/assets/js/28.c970796c.js"><link rel="prefetch" href="/my-blog/assets/js/29.e4674ee9.js"><link rel="prefetch" href="/my-blog/assets/js/30.141008aa.js"><link rel="prefetch" href="/my-blog/assets/js/31.ef5b99f3.js"><link rel="prefetch" href="/my-blog/assets/js/32.d134be95.js"><link rel="prefetch" href="/my-blog/assets/js/33.5b000d47.js"><link rel="prefetch" href="/my-blog/assets/js/34.bca35313.js"><link rel="prefetch" href="/my-blog/assets/js/35.c9d706bf.js"><link rel="prefetch" href="/my-blog/assets/js/36.b437ed1a.js"><link rel="prefetch" href="/my-blog/assets/js/37.e86ae065.js"><link rel="prefetch" href="/my-blog/assets/js/38.6a9b4673.js"><link rel="prefetch" href="/my-blog/assets/js/39.590649cf.js"><link rel="prefetch" href="/my-blog/assets/js/4.bb59c7a2.js"><link rel="prefetch" href="/my-blog/assets/js/40.41cede96.js"><link rel="prefetch" href="/my-blog/assets/js/41.6d8d864d.js"><link rel="prefetch" href="/my-blog/assets/js/42.94936add.js"><link rel="prefetch" href="/my-blog/assets/js/43.e8f1f6c8.js"><link rel="prefetch" href="/my-blog/assets/js/44.4818b939.js"><link rel="prefetch" href="/my-blog/assets/js/45.f16377b8.js"><link rel="prefetch" href="/my-blog/assets/js/46.8daeb3ae.js"><link rel="prefetch" href="/my-blog/assets/js/47.a117cb87.js"><link rel="prefetch" href="/my-blog/assets/js/48.c5860bd4.js"><link rel="prefetch" href="/my-blog/assets/js/49.dfd40b01.js"><link rel="prefetch" href="/my-blog/assets/js/5.773d3189.js"><link rel="prefetch" href="/my-blog/assets/js/50.31bbeafa.js"><link rel="prefetch" href="/my-blog/assets/js/51.ab2c25ee.js"><link rel="prefetch" href="/my-blog/assets/js/52.c3e9f72a.js"><link rel="prefetch" href="/my-blog/assets/js/53.31ad3196.js"><link rel="prefetch" href="/my-blog/assets/js/54.bc937597.js"><link rel="prefetch" href="/my-blog/assets/js/55.a1fbff76.js"><link rel="prefetch" href="/my-blog/assets/js/56.8f009313.js"><link rel="prefetch" href="/my-blog/assets/js/57.bb11633c.js"><link rel="prefetch" href="/my-blog/assets/js/58.b1bb562e.js"><link rel="prefetch" href="/my-blog/assets/js/59.f87e0e56.js"><link rel="prefetch" href="/my-blog/assets/js/6.353538f7.js"><link rel="prefetch" href="/my-blog/assets/js/60.dfe5fc39.js"><link rel="prefetch" href="/my-blog/assets/js/61.a829790e.js"><link rel="prefetch" href="/my-blog/assets/js/62.686739ad.js"><link rel="prefetch" href="/my-blog/assets/js/63.bbedd1e1.js"><link rel="prefetch" href="/my-blog/assets/js/64.636aef4f.js"><link rel="prefetch" href="/my-blog/assets/js/65.139d5a5c.js"><link rel="prefetch" href="/my-blog/assets/js/66.dd6ee5ae.js"><link rel="prefetch" href="/my-blog/assets/js/67.e0d2ee76.js"><link rel="prefetch" href="/my-blog/assets/js/68.f622218a.js"><link rel="prefetch" href="/my-blog/assets/js/69.c0909036.js"><link rel="prefetch" href="/my-blog/assets/js/7.57ae79a3.js"><link rel="prefetch" href="/my-blog/assets/js/70.52ee9a86.js"><link rel="prefetch" href="/my-blog/assets/js/71.7471b31c.js"><link rel="prefetch" href="/my-blog/assets/js/72.0e2e2183.js"><link rel="prefetch" href="/my-blog/assets/js/73.b273bfc6.js"><link rel="prefetch" href="/my-blog/assets/js/74.015cb3a1.js"><link rel="prefetch" href="/my-blog/assets/js/75.d4b5c87b.js"><link rel="prefetch" href="/my-blog/assets/js/76.7d119663.js"><link rel="prefetch" href="/my-blog/assets/js/77.954ed03b.js"><link rel="prefetch" href="/my-blog/assets/js/78.5a078583.js"><link rel="prefetch" href="/my-blog/assets/js/79.351139e1.js"><link rel="prefetch" href="/my-blog/assets/js/8.55fa6f4d.js"><link rel="prefetch" href="/my-blog/assets/js/81.b720117f.js"><link rel="prefetch" href="/my-blog/assets/js/82.57c80203.js"><link rel="prefetch" href="/my-blog/assets/js/83.ebe18815.js"><link rel="prefetch" href="/my-blog/assets/js/84.83e42ca6.js"><link rel="prefetch" href="/my-blog/assets/js/85.7fcb0c21.js"><link rel="prefetch" href="/my-blog/assets/js/86.cc9b45c7.js"><link rel="prefetch" href="/my-blog/assets/js/87.579c23d5.js"><link rel="prefetch" href="/my-blog/assets/js/88.75d9615b.js"><link rel="prefetch" href="/my-blog/assets/js/89.ab3c9f8f.js"><link rel="prefetch" href="/my-blog/assets/js/9.96f51beb.js"><link rel="prefetch" href="/my-blog/assets/js/90.fb273928.js"><link rel="prefetch" href="/my-blog/assets/js/91.0f6e5009.js"><link rel="prefetch" href="/my-blog/assets/js/92.89770dba.js"><link rel="prefetch" href="/my-blog/assets/js/93.81087123.js"><link rel="prefetch" href="/my-blog/assets/js/94.0280bab1.js"><link rel="prefetch" href="/my-blog/assets/js/95.df83fca0.js"><link rel="prefetch" href="/my-blog/assets/js/96.14f4f56c.js"><link rel="prefetch" href="/my-blog/assets/js/97.6ebc8243.js"><link rel="prefetch" href="/my-blog/assets/js/98.dd2e6180.js"><link rel="prefetch" href="/my-blog/assets/js/99.2c402d96.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.5d6174b8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>科纳</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><img src="/my-blog/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录索引
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Webpack/" class="nav-link"><i class="undefined"></i>
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/CI/" class="nav-link"><i class="undefined"></i>
  CI
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Design Partten/" class="nav-link"><i class="undefined"></i>
  Design Partten
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/ES6/" class="nav-link"><i class="undefined"></i>
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/日常整理/" class="nav-link"><i class="undefined"></i>
  日常整理
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Rollup/" class="nav-link"><i class="undefined"></i>
  Rollup
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Sass/" class="nav-link"><i class="undefined"></i>
  Sass
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/源码解读/" class="nav-link"><i class="undefined"></i>
  源码解读
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/TypeScript/" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Vue/" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签索引
</a></div><div class="nav-item"><a href="/my-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      相关链接
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/liuk123456789/blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/my-blog/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    科纳
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>91</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>85</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录索引
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Webpack/" class="nav-link"><i class="undefined"></i>
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/CI/" class="nav-link"><i class="undefined"></i>
  CI
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Design Partten/" class="nav-link"><i class="undefined"></i>
  Design Partten
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/ES6/" class="nav-link"><i class="undefined"></i>
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/日常整理/" class="nav-link"><i class="undefined"></i>
  日常整理
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Rollup/" class="nav-link"><i class="undefined"></i>
  Rollup
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Sass/" class="nav-link"><i class="undefined"></i>
  Sass
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/源码解读/" class="nav-link"><i class="undefined"></i>
  源码解读
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/TypeScript/" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/Vue/" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签索引
</a></div><div class="nav-item"><a href="/my-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      相关链接
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/liuk123456789/blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>pinia</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>dayjs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vitual-scroll</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue cli</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>async validator</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>vue router</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/blogs/source/vue-router/basic.html" class="sidebar-link">vue-router 第一篇</a></li><li><a href="/my-blog/blogs/source/vue-router/createRouter.html" class="sidebar-link">vue-router 第三篇</a></li><li><a href="/my-blog/blogs/source/vue-router/matcher.html" class="sidebar-link">vue-router 第二篇</a></li><li><a href="/my-blog/blogs/source/vue-router/push.html" aria-current="page" class="active sidebar-link">vue-router 第四篇</a></li><li><a href="/my-blog/blogs/source/vue-router/routerGuard.html" class="sidebar-link">vue-router 第五篇</a></li><li><a href="/my-blog/blogs/source/vue-router/use.html" class="sidebar-link">vue-router 第六篇</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>vue-router 第四篇</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>科纳</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">vue-router 第四篇</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>科纳</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>5/23/2023</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/my-blog/blogs/source/vue-router/push.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>vue router</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="_1-push"><a href="#_1-push" class="header-anchor">#</a> 1. push</h2> <p>代码如下</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationRaw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="pushwithredirect"><a href="#pushwithredirect" class="header-anchor">#</a> pushWithRedirect</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
    to<span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocation<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> RouteLocation
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析传递的to</span>
    <span class="token keyword">const</span> targetLocation<span class="token operator">:</span> RouteLocation <span class="token operator">=</span> <span class="token punctuation">(</span>pendingLocation <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 当前的路由</span>
    <span class="token keyword">const</span> from <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>value
    <span class="token comment">// state对象</span>
    <span class="token keyword">const</span> data<span class="token operator">:</span> HistoryState <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>state
    <span class="token comment">// 强制触发导航</span>
    <span class="token keyword">const</span> force<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>force
    <span class="token comment">// 是否替换历史记录</span>
    <span class="token keyword">const</span> replace <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>replace <span class="token operator">===</span> <span class="token boolean">true</span>
	<span class="token comment">// 获取需要重定向的记录</span>
    <span class="token keyword">const</span> shouldRedirect <span class="token operator">=</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span>targetLocation<span class="token punctuation">)</span>
	
    <span class="token comment">// 需要进行重定向</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">)</span>
      <span class="token comment">// 递归下</span>
      <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
        <span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          state<span class="token operator">:</span>
            <span class="token keyword">typeof</span> shouldRedirect <span class="token operator">===</span> <span class="token string">'object'</span>
              <span class="token operator">?</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> shouldRedirect<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
              <span class="token operator">:</span> data<span class="token punctuation">,</span>
          force<span class="token punctuation">,</span>
          replace<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// keep original redirectedFrom if it exists</span>
        redirectedFrom <span class="token operator">||</span> targetLocation
      <span class="token punctuation">)</span>

    <span class="token comment">// if it was a redirect we already called `pushWithRedirect` above</span>
    <span class="token keyword">const</span> toLocation <span class="token operator">=</span> targetLocation <span class="token keyword">as</span> RouteLocationNormalized

    toLocation<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> redirectedFrom
    <span class="token keyword">let</span> failure<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>stringifyQuery<span class="token punctuation">,</span> from<span class="token punctuation">,</span> targetLocation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      failure <span class="token operator">=</span> <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationFailure<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_DUPLICATED</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> to<span class="token operator">:</span> toLocation<span class="token punctuation">,</span> from <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
      <span class="token comment">// trigger scroll to allow scrolling to the same anchor</span>
      <span class="token function">handleScroll</span><span class="token punctuation">(</span>
        from<span class="token punctuation">,</span>
        from<span class="token punctuation">,</span>
        <span class="token comment">// this is a push, the only way for it to be triggered from a</span>
        <span class="token comment">// history.listen is with a redirect, which makes it become a push</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// This cannot be the first navigation because the initial location</span>
        <span class="token comment">// cannot be manually navigated to</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>failure <span class="token operator">?</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">navigate</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token comment">// navigation redirects still mark the router as ready</span>
            <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_GUARD_REDIRECT</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> error
            <span class="token operator">:</span> <span class="token function">markAsReady</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// also returns the error</span>
          <span class="token operator">:</span> <span class="token comment">// reject any unknown error</span>
            <span class="token function">triggerError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>failure<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>failure<span class="token punctuation">,</span> ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_GUARD_REDIRECT</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
              __DEV__ <span class="token operator">&amp;&amp;</span>
              <span class="token comment">// we are redirecting to the same location we were already at</span>
              <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>
                stringifyQuery<span class="token punctuation">,</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span>
                toLocation
              <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
              <span class="token comment">// and we have done it a couple of times</span>
              redirectedFrom <span class="token operator">&amp;&amp;</span>
              <span class="token comment">// @ts-expect-error: added only in dev</span>
              <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">.</span>_count <span class="token operator">=</span> redirectedFrom<span class="token punctuation">.</span>_count
                <span class="token operator">?</span> <span class="token comment">// @ts-expect-error</span>
                  redirectedFrom<span class="token punctuation">.</span>_count <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">30</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">warn</span><span class="token punctuation">(</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Detected a possibly infinite redirection in a navigation guard when going from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>from<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>toLocation<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Aborting to avoid a Stack Overflow.\n Are you always returning a new location within a navigation guard? That would lead to this error. Only return when redirecting or aborting, that should fix this. This might break in production if not fixed.</span><span class="token template-punctuation string">`</span></span>
              <span class="token punctuation">)</span>
              <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Infinite redirect in navigation guard'</span><span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
              <span class="token comment">// keep options</span>
              <span class="token function">assign</span><span class="token punctuation">(</span>
                <span class="token punctuation">{</span>
                  <span class="token comment">// preserve an existing replacement but allow the redirect to override it</span>
                  replace<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">locationAsObject</span><span class="token punctuation">(</span>failure<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  state<span class="token operator">:</span>
                    <span class="token keyword">typeof</span> failure<span class="token punctuation">.</span>to <span class="token operator">===</span> <span class="token string">'object'</span>
                      <span class="token operator">?</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> failure<span class="token punctuation">.</span>to<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
                      <span class="token operator">:</span> data<span class="token punctuation">,</span>
                  force<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token comment">// preserve the original redirectedFrom if any</span>
              redirectedFrom <span class="token operator">||</span> toLocation
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// if we fail we don't finalize the navigation</span>
          failure <span class="token operator">=</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
            toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
            from<span class="token punctuation">,</span>
            <span class="token boolean">true</span><span class="token punctuation">,</span>
            replace<span class="token punctuation">,</span>
            data
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>
          toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
          from<span class="token punctuation">,</span>
          failure
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> failure
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br></div></div><h3 id="handleredirectrecord"><a href="#handleredirectrecord" class="header-anchor">#</a> handleRedirectRecord</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocation<span class="token punctuation">)</span><span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// 找到匹配的路由，to.matched中的路由顺序是父路由在子路由前面，所以最后一个路由是我们的最终路由</span>
    <span class="token keyword">const</span> lastMatched <span class="token operator">=</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">// 如果路由存在redirect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastMatched <span class="token operator">&amp;&amp;</span> lastMatched<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token operator">=</span> lastMatched
      <span class="token comment">// redirect是否是函数，函数的话执行，否则取redirect</span>
      <span class="token keyword">let</span> newTargetLocation <span class="token operator">=</span>
        <span class="token keyword">typeof</span> redirect <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">redirect</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span> <span class="token operator">:</span> redirect

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newTargetLocation <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newTargetLocation <span class="token operator">=</span>
          newTargetLocation<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">||</span> newTargetLocation<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
            <span class="token comment">// 调用pathURL 生成{ fullPath, path, query, hash }结构</span>
            <span class="token operator">?</span> <span class="token punctuation">(</span>newTargetLocation <span class="token operator">=</span> <span class="token function">locationAsObject</span><span class="token punctuation">(</span>newTargetLocation<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token comment">// 无参数路由</span>
              <span class="token punctuation">{</span> path<span class="token operator">:</span> newTargetLocation <span class="token punctuation">}</span>
        <span class="token comment">// @ts-expect-error: force empty params when a string is passed to let</span>
        <span class="token comment">// the router parse them again</span>
        newTargetLocation<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        __DEV__ <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'path'</span> <span class="token keyword">in</span> newTargetLocation<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'name'</span> <span class="token keyword">in</span> newTargetLocation<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid redirect found:\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
            newTargetLocation<span class="token punctuation">,</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token number">2</span>
          <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n when navigating to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
            to<span class="token punctuation">.</span>fullPath
          <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. A redirect must contain a name or path. This will break in production.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid redirect'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">assign</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          query<span class="token operator">:</span> to<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
          hash<span class="token operator">:</span> to<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
          <span class="token comment">// avoid transferring params if the redirect has a path</span>
          params<span class="token operator">:</span> <span class="token string">'path'</span> <span class="token keyword">in</span> newTargetLocation <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> to<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        newTargetLocation
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="跳转路由和当前路由同一的处理"><a href="#跳转路由和当前路由同一的处理" class="header-anchor">#</a> 跳转路由和当前路由同一的处理</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>stringifyQuery<span class="token punctuation">,</span> from<span class="token punctuation">,</span> targetLocation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  failure <span class="token operator">=</span> <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationFailure<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_DUPLICATED</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> to<span class="token operator">:</span> toLocation<span class="token punctuation">,</span> from <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// trigger scroll to allow scrolling to the same anchor</span>
  <span class="token function">handleScroll</span><span class="token punctuation">(</span>
    from<span class="token punctuation">,</span>
    from<span class="token punctuation">,</span>
    <span class="token comment">// this is a push, the only way for it to be triggered from a</span>
    <span class="token comment">// history.listen is with a redirect, which makes it become a push</span>
    <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// This cannot be the first navigation because the initial location</span>
    <span class="token comment">// cannot be manually navigated to</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>isSameRouteLocation</strong></p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">/**
 * Checks if two RouteLocation are equal. This means that both locations are
 * pointing towards the same {@link RouteRecord} and that all `params`, `query`
 * parameters and `hash` are the same
 *
 * @param stringifyQuery - A function that takes a query object of type LocationQueryRaw and returns a string representation of it.
 * @param a - first {@link RouteLocation}
 * @param b - second {@link RouteLocation}
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>
  <span class="token function-variable function">stringifyQuery</span><span class="token operator">:</span> <span class="token punctuation">(</span>query<span class="token operator">:</span> LocationQueryRaw<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  a<span class="token operator">:</span> RouteLocation<span class="token punctuation">,</span>
  b<span class="token operator">:</span> RouteLocation
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> aLastIndex <span class="token operator">=</span> a<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">const</span> bLastIndex <span class="token operator">=</span> b<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token comment">// 比对规则</span>
  <span class="token comment">// 1. from matched的length必须大于0</span>
  <span class="token comment">// 2. 两者matched的最后一个元素相同</span>
  <span class="token comment">// 3. 同一个路由记录</span>
  <span class="token comment">// 4. 参数必须一致</span>
  <span class="token comment">// 5. query 必须一致</span>
  <span class="token comment">// 6. hash 必须一致</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    aLastIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    aLastIndex <span class="token operator">===</span> bLastIndex <span class="token operator">&amp;&amp;</span>
    <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>aLastIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>bLastIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>params<span class="token punctuation">,</span> b<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">stringifyQuery</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">stringifyQuery</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>hash <span class="token operator">===</span> b<span class="token punctuation">.</span>hash
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Check if two `RouteRecords` are equal. Takes into account aliases: they are
 * considered equal to the `RouteRecord` they are aliasing.
 *
 * @param a - first {@link RouteRecord}
 * @param b - second {@link RouteRecord}
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>a<span class="token operator">:</span> RouteRecord<span class="token punctuation">,</span> b<span class="token operator">:</span> RouteRecord<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token comment">// since the original record has an undefined value for aliasOf</span>
  <span class="token comment">// but all aliases point to the original record, this will always compare</span>
  <span class="token comment">// the original record</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>aliasOf <span class="token operator">||</span> a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>aliasOf <span class="token operator">||</span> b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span>
  a<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!==</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameRouteLocationParamsValue</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isSameRouteLocationParamsValue</span><span class="token punctuation">(</span>
  a<span class="token operator">:</span> RouteParamValue <span class="token operator">|</span> <span class="token keyword">readonly</span> RouteParamValue<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> RouteParamValue <span class="token operator">|</span> <span class="token keyword">readonly</span> RouteParamValue<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token function">isEquivalentArray</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">isArray</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token function">isEquivalentArray</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
    <span class="token operator">:</span> a <span class="token operator">===</span> b
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Check if two arrays are the same or if an array with one single entry is the
 * same as another primitive value. Used to check query and parameters
 *
 * @param a - array of values
 * @param b - array of values or a single value
 */</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">isEquivalentArray</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token keyword">readonly</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token keyword">readonly</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isArray</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token operator">?</span> a<span class="token punctuation">.</span>length <span class="token operator">===</span> b<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value <span class="token operator">===</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> a<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> b
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>当<code>!force &amp;&amp; isSameRouteLocation(stringifyQuery, from, targetLocation)</code>为真时，创建错误信息，错误信息代表着重复导航，处理滚动行为<code>handleScroll</code></p> <h3 id="handlescroll"><a href="#handlescroll" class="header-anchor">#</a> handleScroll</h3> <p>首先从<code>options</code>中找到<code>scrollBehavior</code>选项，如果不是浏览器环境或不存在<code>scrollBehavior</code>，返回一个<code>Promise</code>对象。相反，获取滚动位置（根据历史记录中的<code>position</code>和<code>path</code>获取），然后在下一次<code>DOM</code>刷新后，执行定义的滚动行为函数，滚动行为函数执行完后，将滚动行为函数结果作为最终的滚动位置将页面滚动到指定位置</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// Scroll behavior</span>
<span class="token keyword">function</span> <span class="token function">handleScroll</span><span class="token punctuation">(</span>
    to<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
    from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
    isPush<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    isFirstNavigation<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> scrollBehavior <span class="token punctuation">}</span> <span class="token operator">=</span> options
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isBrowser <span class="token operator">||</span> <span class="token operator">!</span>scrollBehavior<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> scrollPosition<span class="token operator">:</span> _ScrollPositionNormalized <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>isPush <span class="token operator">&amp;&amp;</span> <span class="token function">getSavedScrollPosition</span><span class="token punctuation">(</span><span class="token function">getScrollKey</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>isFirstNavigation <span class="token operator">||</span> <span class="token operator">!</span>isPush<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>history<span class="token punctuation">.</span>state <span class="token keyword">as</span> HistoryState<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        history<span class="token punctuation">.</span>state<span class="token punctuation">.</span>scroll<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token keyword">null</span>

    <span class="token keyword">return</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">scrollBehavior</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> scrollPosition<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>position <span class="token operator">=&gt;</span> position <span class="token operator">&amp;&amp;</span> <span class="token function">scrollToPosition</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token function">triggerError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在<code>pushWithRedirect</code>最后返回一个<code>Promise</code>。如果有<code>failure</code>，返回<code>failure</code>。如果没有<code>failure</code>则执行<code>navigate(toLocation, from)</code>。</p> <p>那么<code>navigate</code>是做什么的呢？<code>navigate</code>函数接收两个参数：<code>to</code>、<code>from</code>。</p> <p><code>navigate</code>中首先调用了一个<code>extractChangingRecords</code>函数，该函数的作用是将<code>from</code>、<code>to</code>所匹配到的路由分别存到三个数组中：<code>from</code>、<code>to</code>所共有的路由放入<code>updatingRecords</code>（正在更新的路由）、<code>from</code>独有的路由放入<code>leavingRecords</code>（正要离开的路由）、<code>to</code>独有的路由放入<code>enteringRecords</code>（正在进入的新路由）。紧接着又调用了一个<code>extractComponentsGuards</code>函数，用来获取组件内的<code>beforeRouteLeave</code>钩子，注意<code>extractComponentsGuards</code>函数只能获取使用<code>beforeRouteLeave(){}</code>方式注册的函数，对于使用<code>onBeforeRouteLeave</code>注册的函数需要单独处理。</p> <p><code>navigate</code>代码如下</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// TODO: refactor the whole before guards by internally using router.beforeEach</span>

<span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>
    to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
    from<span class="token operator">:</span> RouteLocationNormalizedLoaded
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> guards<span class="token operator">:</span> Lazy<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span> <span class="token operator">=</span>
      <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span>

    guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
      <span class="token comment">// 这里leavingRecords需要反转，因为matched中的顺序是父路由在子路由前，当离开时，应先离开子路由再离开父路由</span>
      leavingRecords<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'beforeRouteLeave'</span><span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      from
    <span class="token punctuation">)</span>

    <span class="token comment">// 向guards中添加使用onBeforeRouteLeave方式注册的方法</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> leavingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      record<span class="token punctuation">.</span>leaveGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果发生了新的导航canceledNavigationCheck可以帮助跳过后续所有的导航</span>
    <span class="token keyword">const</span> canceledNavigationCheck <span class="token operator">=</span> <span class="token function">checkCanceledNavigationAndReject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      from
    <span class="token punctuation">)</span>

    guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

    <span class="token comment">// run the queue of per route beforeRouteLeave guards</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check global guards beforeEach</span>
          guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check in components beforeRouteUpdate</span>
          guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
            updatingRecords<span class="token punctuation">,</span>
            <span class="token string">'beforeRouteUpdate'</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            from
          <span class="token punctuation">)</span>

          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> updatingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            record<span class="token punctuation">.</span>updateGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

          <span class="token comment">// run the queue of per route beforeEnter guards</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check the route beforeEnter</span>
          guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// do not trigger beforeEnter on reused views</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> beforeEnter <span class="token keyword">of</span> record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span>
                  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

          <span class="token comment">// run the queue of per route beforeEnter guards</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// NOTE: at this point to.matched is normalized and does not contain any () =&gt; Promise&lt;Component&gt;</span>

          <span class="token comment">// clear existing enterCallbacks, these are added by extractComponentsGuards</span>
          to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>record <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>enterCallbacks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

          <span class="token comment">// check in-component beforeRouteEnter</span>
          guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
            enteringRecords<span class="token punctuation">,</span>
            <span class="token string">'beforeRouteEnter'</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            from
          <span class="token punctuation">)</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

          <span class="token comment">// run the queue of per route beforeEnter guards</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check global guards beforeResolve</span>
          guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeResolveGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// catch any navigation canceled</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span>
          <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_CANCELLED</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> err
            <span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><p><code>extractChangingRecords</code>的实现过程：如果<code>to</code>和<code>from</code>匹配到的路由中有公共的，说明这些路由在跳转过程中是更新操作，将其加入<code>updatingRecords</code>中；如果是<code>from</code>所匹配到独有的路由，说明要离开这些路由，将它们放入<code>leavingRecords</code>中；相反，如果<code>to</code>匹配到的路由中，<code>from</code>没有匹配到，说明是新的路由，将它们放入<code>enteringRecords</code>中。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 要离开的路由</span>
  <span class="token keyword">const</span> leavingRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 更新的路由</span>
  <span class="token keyword">const</span> updatingRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 要进入的新的路由（在from.matched中未出现过）</span>
  <span class="token keyword">const</span> enteringRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">const</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">,</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> recordFrom <span class="token operator">=</span> from<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果recordFrom在to.matched中存在，将recordFrom加入到updatingRecords，否则加入到leavingRecords中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>record <span class="token operator">=&gt;</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> recordFrom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        updatingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span>
      <span class="token keyword">else</span> leavingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> recordTo <span class="token operator">=</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果recordTo在from.matched中找不到，说明是个新的路由，将recordTo加入到enteringRecords</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>record <span class="token operator">=&gt;</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> recordTo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        enteringRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><code>extractComponentsGuards</code>是专门用来从路由组件中提取钩子函数的。<code>extractComponentsGuards</code>接收四个参数：<code>matched</code>（从<code>to</code>、<code>from</code>中提取出的<code>leavingRecords</code>、<code>updatingRecords</code>、<code>enteringRecords</code>之一）、<code>guardType</code>（钩子类型，可以取的值<code>beforeRouteEnter</code>、<code>beforeRouteUpdate</code>、<code>beforeRouteLeave</code>）、<code>to</code>、<code>from</code>。返回值是一个钩子函数列表</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
  matched<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  guardType<span class="token operator">:</span> GuardType<span class="token punctuation">,</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 声明一个数组保存钩子函数</span>
  <span class="token keyword">const</span> guards<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历路由对应的组件components</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">in</span> record<span class="token punctuation">.</span>components<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> rawComponent <span class="token operator">=</span> record<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token comment">// 开发环境下进行提示</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果组件不存在或组件不是object和function，提示不是有效的组件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token operator">!</span>rawComponent <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> rawComponent <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
            <span class="token keyword">typeof</span> rawComponent <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Component &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in record with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is not</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> a valid component. Received &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>rawComponent<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
          <span class="token comment">// 抛出错误</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid route component'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'then'</span> <span class="token keyword">in</span> rawComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果使用import('./xxx.vue')的方式使用组件，进行提示，并转为() =&gt; import('./xxx.vue')</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Component &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in record with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is a </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise instead of a function that returns a Promise. Did you </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">write &quot;import('./MyPage.vue')&quot; instead of </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;() =&gt; import('./MyPage.vue')&quot; ? This will break in </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">production if not fixed.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
          <span class="token keyword">const</span> promise <span class="token operator">=</span> rawComponent
          <span class="token function-variable function">rawComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> promise
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token punctuation">(</span>rawComponent <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__asyncLoader <span class="token operator">&amp;&amp;</span>
          <span class="token comment">// warn only once per component</span>
          <span class="token operator">!</span><span class="token punctuation">(</span>rawComponent <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__warnedDefineAsync
        <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果使用defineAsyncComponent()方式定义的组件，进行提示</span>
          <span class="token punctuation">;</span><span class="token punctuation">(</span>rawComponent <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__warnedDefineAsync <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Component &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in record with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is defined </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">using &quot;defineAsyncComponent()&quot;. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Write &quot;() =&gt; import('./MyPage.vue')&quot; instead of </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;defineAsyncComponent(() =&gt; import('./MyPage.vue'))&quot;.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 如果路由组件没有被挂载跳过update和leave钩子</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>guardType <span class="token operator">!==</span> <span class="token string">'beforeRouteEnter'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>record<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token comment">// 如果是个路由组件</span>
      <span class="token comment">// 路由组件需要满足：rawComponent是object || rawComponent有['displayName', 'props`、`__vccOpts`]中的任一属性</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRouteComponent</span><span class="token punctuation">(</span>rawComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// __vccOpts是由vue-class-component添加的</span>
        <span class="token keyword">const</span> options<span class="token operator">:</span> ComponentOptions <span class="token operator">=</span>
          <span class="token punctuation">(</span>rawComponent <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__vccOpts <span class="token operator">||</span> rawComponent
        <span class="token keyword">const</span> guard <span class="token operator">=</span> options<span class="token punctuation">[</span>guardType<span class="token punctuation">]</span>
        <span class="token comment">// 向guards中添加一个异步函数</span>
        guard <span class="token operator">&amp;&amp;</span> guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> record<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 能进入这个方法的表示rawComponent是个函数；例如懒加载() =&gt; import('./xx.vue')；函数式组件() =&gt; h('div', 'HomePage')</span>
        <span class="token comment">// 注意这个的分支只发生在调用beforeRouteEnter之前，后续过程不会进行该过程。</span>
        <span class="token comment">// 因为在调用beforeRouteEnter钩子之前，会进行异步路由组件的解析，一旦异步路由组件解析成功，会将解析后的组件挂载至对应的components[name]下</span>
        
        <span class="token comment">// 执行rawComponent，例如懒加载() =&gt; import('./xx.vue')；如果函数式组件未声明displayName也会进入此分支</span>
        <span class="token keyword">let</span> componentPromise<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>
          RouteComponent <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">|</span> <span class="token keyword">void</span>
        <span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>rawComponent <span class="token keyword">as</span> Lazy<span class="token operator">&lt;</span>RouteComponent<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 对于函数式组件需要添加一个displayName属性，如果没有，进行提示，并将componentPromise转为一个Promise</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'catch'</span> <span class="token keyword">in</span> componentPromise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Component &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in record with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is a function that does not return a Promise. If you were passing a functional component, make sure to add a &quot;displayName&quot; to the component. This will break in production if not fixed.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
          componentPromise <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>componentPromise <span class="token keyword">as</span> RouteComponent<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 向guards中添加一个钩子函数，在这个钩子的执行过程中先解析异步路由组件，然后调用钩子函数</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
          componentPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolved <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果解析失败抛出错误</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolved<span class="token punctuation">)</span>
              <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
                  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Couldn't resolve component &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; at &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
                <span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
            <span class="token comment">// 判断解析后的组件是否为esm，如果是esm，需要取resolved.default</span>
            <span class="token keyword">const</span> resolvedComponent <span class="token operator">=</span> <span class="token function">isESModule</span><span class="token punctuation">(</span>resolved<span class="token punctuation">)</span>
              <span class="token operator">?</span> resolved<span class="token punctuation">.</span>default
              <span class="token operator">:</span> resolved
            <span class="token comment">// 使用解析完的组件替换对应的components[name]</span>
            record<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedComponent
            <span class="token keyword">const</span> options<span class="token operator">:</span> ComponentOptions <span class="token operator">=</span>
              <span class="token punctuation">(</span>resolvedComponent <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__vccOpts <span class="token operator">||</span> resolvedComponent
            <span class="token comment">// 对应的组件内的钩子</span>
            <span class="token keyword">const</span> guard <span class="token operator">=</span> options<span class="token punctuation">[</span>guardType<span class="token punctuation">]</span>
            <span class="token comment">// 钩子转promise，并执行</span>
            <span class="token keyword">return</span> guard <span class="token operator">&amp;&amp;</span> <span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> record<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> guards
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><p>在<code>navigate</code>函数最后会调用<code>guards</code>中的钩子，并在<code>beforeRouteLeave</code>钩子执行完后执行了一系列操作。其实在这里就体现了<code>vue-router</code>中钩子的执行顺序：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用全局beforeEach钩子</span>
        guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取组件中的beforeRouteUpdate钩子，以beforeRouteUpdate() {}方式声明</span>
        guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
          updatingRecords<span class="token punctuation">,</span>
          <span class="token string">'beforeRouteUpdate'</span><span class="token punctuation">,</span>
          to<span class="token punctuation">,</span>
          from
        <span class="token punctuation">)</span>

        <span class="token comment">// 以onBeforeRouteUpdate注册的</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> updatingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          record<span class="token punctuation">.</span>updateGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

        <span class="token comment">// 调用beforeRouteUpdate钩子</span>
        <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 不在重用视图上触发beforeEnter</span>
          <span class="token comment">// 路由配置中有beforeEnter，并且from不匹配record</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> beforeEnter <span class="token keyword">of</span> record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span>
                guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

        <span class="token comment">// 调用路由配置中的beforeEnter</span>
        <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">// 清除存在的enterCallbacks 由extractComponentsGuards添加</span>
        to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>record <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>enterCallbacks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 获取被激活组件中的beforeRouteEnter钩子，在之前会处理异步路由组件</span>
        guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
          enteringRecords<span class="token punctuation">,</span>
          <span class="token string">'beforeRouteEnter'</span><span class="token punctuation">,</span>
          to<span class="token punctuation">,</span>
          from
        <span class="token punctuation">)</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">// 处理全局beforeResolve钩子</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeResolveGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 捕获任何取消的导航</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span>
        <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_CANCELLED</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> err
          <span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>通过上诉的返回值，我们可以看出，<code>vue-router</code>的钩子执行顺序为</p> <div class="language-tex line-numbers-mode"><pre class="language-tex"><code>1. 导航被触发
2. 调用失活组件的beforeRouteLeave
3. 调用全局的beforeEach
4. 复用组件的beforeRouteUpdate
5. 路由配置中beforeEnter
6. 解析异步路由组件
7. 组件的beforeRouteEnter
8. 全局钩子beforeResolve
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>trigger</code>一个周期的钩子函数之后，都会紧跟着向<code>guards</code>中<code>push</code>一个<code>canceledNavigationCheck</code>函数。这个<code>canceledNavigationCheck</code>的函数作用是如果在导航期间有了新的导航，则会<code>reject</code>一个<code>ErrorTypes.NAVIGATION_CANCELLED</code>错误信息。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">checkCanceledNavigationAndReject</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalized
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
  <span class="token keyword">return</span> error <span class="token operator">?</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalized
<span class="token punctuation">)</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingLocation <span class="token operator">!==</span> to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationFailure<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
      ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_CANCELLED</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        from<span class="token punctuation">,</span>
        to<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在向<code>guards</code>中放入钩子时，都使用了一个<code>guardToPromiseFn</code>，<code>guardToPromiseFn</code>可以将钩子函数转为<code>promise</code>函数。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>
  guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  record<span class="token operator">?</span><span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">,</span>
  name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> enterCallbackArray <span class="token operator">=</span>
    record <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>record<span class="token punctuation">.</span>enterCallbacks<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>enterCallbacks<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这个next函数就是beforeRouteEnter中的next</span>
      <span class="token keyword">const</span> next<span class="token operator">:</span> <span class="token function-variable function">NavigationGuardNext</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
        valid<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> RouteLocationRaw <span class="token operator">|</span> NavigationGuardNextCallback <span class="token operator">|</span> Error
      <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果调用next时传入的是false，取消导航</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>
            <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationFailure<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
              ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_ABORTED</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                from<span class="token punctuation">,</span>
                to<span class="token punctuation">,</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果传入了一个Error实例</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRouteLocation</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是个路由。可以进行重定向</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>
            <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationRedirectError<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
              ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_GUARD_REDIRECT</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                from<span class="token operator">:</span> to<span class="token punctuation">,</span>
                to<span class="token operator">:</span> valid<span class="token punctuation">,</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果valid是个函数，会将这个函数添加到record.enterCallbacks[name]中</span>
          <span class="token comment">// 关于record.enterCallbacks的执行时机，将会在RouterView中进行分析</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            enterCallbackArray <span class="token operator">&amp;&amp;</span>
            <span class="token comment">// since enterCallbackArray is truthy, both record and name also are</span>
            record<span class="token operator">!</span><span class="token punctuation">.</span>enterCallbacks<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">===</span> enterCallbackArray <span class="token operator">&amp;&amp;</span>
            <span class="token keyword">typeof</span> valid <span class="token operator">===</span> <span class="token string">'function'</span>
          <span class="token punctuation">)</span>
            enterCallbackArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 调用guard，绑定this为组件实例</span>
      <span class="token keyword">const</span> guardReturn <span class="token operator">=</span> <span class="token function">guard</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
        record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        to<span class="token punctuation">,</span>
        from<span class="token punctuation">,</span>
        <span class="token comment">// next应该只允许被调用一次，如果使用了多次开发环境下给出提示</span>
        __DEV__ <span class="token operator">?</span> <span class="token function">canOnlyBeCalledOnce</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span> <span class="token operator">:</span> next
      <span class="token punctuation">)</span>
      <span class="token comment">// 使用Promise.resolve包装guard的返回结果，以允许异步guard</span>
      <span class="token keyword">let</span> guardCall <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>guardReturn<span class="token punctuation">)</span>

      <span class="token comment">// 如果guard参数小于3,guardReturn会作为next的参数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> guardCall <span class="token operator">=</span> guardCall<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
      <span class="token comment">// 如果guard参数大于2</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> guard<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The &quot;next&quot; callback was never called inside of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
          guard<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token string">'&quot;'</span> <span class="token operator">+</span> guard<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'&quot;'</span> <span class="token operator">:</span> <span class="token string">''</span>
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>guard<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n. If you are returning a value instead of calling &quot;next&quot;, make sure to remove the &quot;next&quot; parameter from your function.</span><span class="token template-punctuation string">`</span></span>
        <span class="token comment">// guardReturn是个promise</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> guardReturn <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token string">'then'</span> <span class="token keyword">in</span> guardReturn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          guardCall <span class="token operator">=</span> guardCall<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolvedValue <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 未调用next。如：</span>
            <span class="token comment">// beforeRouteEnter(to, from ,next) {</span>
            <span class="token comment">//  return Promise.resolve(11)</span>
            <span class="token comment">// }</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>_called<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
              <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid navigation guard'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> resolvedValue
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment">// TODO: test me!</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>guardReturn <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果有返回值，并且未调用next。如</span>
          <span class="token comment">// beforeRouteEnter(to, from ,next) {</span>
          <span class="token comment">//  return 11</span>
          <span class="token comment">// }</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>_called<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid navigation guard'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 捕获错误</span>
      guardCall<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p><code>guardToPromiseFn</code>中声明的的<code>next</code>方法会作为钩子函数的第三个参数。如果在使用钩子函数时，形参的数量&lt;3，那么钩子函数的返回值会作为<code>next</code>函数的参数；形参数量&gt;2时，如果钩子函数的返回值是<code>Promise</code>，但未调用<code>next</code>，会抛出错误<code>Invalid navigation guard</code>，如果钩子函数的返回值不为<code>undefined</code>，也未调用<code>next</code>也会抛出错误<code>Invalid navigation guard</code>。</p> <p>所以如果在使用路由钩子的过程中，如果钩子函数的形参&gt;2，也就是你的形参中有<code>next</code>，你必须要调用<code>next</code>。如果你不想自己调用<code>next</code>，那么你要保证形参&lt;2，同时钩子函数返回某个数据，这样<code>vue-router</code>会自动调用<code>next</code>。这里需要注意如果传递给<code>next</code>的参数是个<code>function</code>，那么这个<code>function</code>会被存入<code>record.enterCallbacks[name]</code>中，关于<code>enterCallbacks</code>的执行时机，后面会说到的</p> <p>执行钩子列表的函数<code>runGuardQueue</code>，只有当前钩子执行完毕，才会执行下一个钩子：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token operator">:</span> Lazy<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> guards<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> guard<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">runWithContext</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">runWithContext</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app<span class="token operator">:</span> App <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> installedApps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
    <span class="token comment">// support Vue &lt; 3.3</span>
    <span class="token keyword">return</span> app <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> app<span class="token punctuation">.</span>runWithContext <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> app<span class="token punctuation">.</span><span class="token function">runWithContext</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在<code>pushWithRedirect</code>函数最后，在<code>navigate</code>执行完后并没有结束，而是又进行了以下操作：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 首先判断之前的操作是否出错</span>
<span class="token comment">// 如果出错，将failure使用Promise.resolve包装，进入.then</span>
<span class="token comment">// 如果未出错，调用navigate()，navigate过程中失败，进入.catch，成功进入.then</span>
<span class="token comment">// 注意这里catch发生在then之前，所以catch运行完，可能会继续进入then</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>failure <span class="token operator">?</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">navigate</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token operator">?</span> 
      <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_GUARD_REDIRECT</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> error <span class="token comment">// navigate过程中发生的重定向，进入.then</span>
        <span class="token operator">:</span> <span class="token function">markAsReady</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token comment">// reject 未知的错误</span>
      <span class="token function">triggerError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>failure<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是重定向错误</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>failure<span class="token punctuation">,</span> ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_GUARD_REDIRECT</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是循环的重定向（检测循环次数超过10次）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          __DEV__ <span class="token operator">&amp;&amp;</span>
          <span class="token comment">// 重定向的位置与toLocation相同</span>
          <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>
            stringifyQuery<span class="token punctuation">,</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span>
            toLocation
          <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          redirectedFrom <span class="token operator">&amp;&amp;</span>
          <span class="token comment">// 循环次数</span>
          <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">.</span>_count <span class="token operator">=</span> redirectedFrom<span class="token punctuation">.</span>_count
            <span class="token operator">?</span> 
            redirectedFrom<span class="token punctuation">.</span>_count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Detected an infinite redirection in a navigation guard when going from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>from<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>toLocation<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Aborting to avoid a Stack Overflow. This will break in production if not fixed.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Infinite redirect in navigation guard'</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 递归调用pushWithRedirect，进行重定向</span>
        <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
          <span class="token comment">// keep options</span>
          <span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>failure<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            state<span class="token operator">:</span> data<span class="token punctuation">,</span>
            force<span class="token punctuation">,</span>
            replace<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// preserve the original redirectedFrom if any</span>
          redirectedFrom <span class="token operator">||</span> toLocation
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果在navigate过程中没有抛出错误信息</span>
      failure <span class="token operator">=</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
        toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
        from<span class="token punctuation">,</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span>
        replace<span class="token punctuation">,</span>
        data
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 触发全局afterEach钩子</span>
    <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>
      toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
      from<span class="token punctuation">,</span>
      failure
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> failure
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p>可以发现，如果<code>navigate</code>过程执行顺利的话，最后会执行一个<code>finalizeNavigation</code>方法，然后触发全局<code>afterEach</code>钩子。那么我们来看下<code>finalizeNavigation</code>是做什么的。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
  toLocation<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  isPush<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  replace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token operator">:</span> HistoryState
<span class="token punctuation">)</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查是否取消了导航</span>
  <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> error

  <span class="token comment">// 第一次导航</span>
  <span class="token keyword">const</span> isFirstNavigation <span class="token operator">=</span> from <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token operator">!</span>isBrowser <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> history<span class="token punctuation">.</span>state

  <span class="token comment">// 仅当用户进行了push/replace并且不是初始导航时才更改 URL，因为它只是反映了 url</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// replace为true或首次导航，使用routerHistory.replace </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>replace <span class="token operator">||</span> isFirstNavigation<span class="token punctuation">)</span>
      routerHistory<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        toLocation<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
        <span class="token function">assign</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span>
            <span class="token comment">// 如果是第一次导航，重用history.state中的scroll</span>
            scroll<span class="token operator">:</span> isFirstNavigation <span class="token operator">&amp;&amp;</span> state <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>scroll<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          data
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token keyword">else</span> routerHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// toLocation成为了当前导航</span>
  currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> toLocation
  <span class="token comment">// 处理滚动</span>
  <span class="token function">handleScroll</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">,</span> isPush<span class="token punctuation">,</span> isFirstNavigation<span class="token punctuation">)</span>

  <span class="token comment">// 路由相关操作准备完毕</span>
  <span class="token function">markAsReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>可以看出<code>finalizeNavigation</code>函数的作用是确认我们的导航，它主要做两件事：改变<code>url</code>(如果需要改变)、处理滚动行为。在最后有个<code>markAsReady</code>方法，我们继续看<code>markAsReady</code>是做什么的。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">markAsReady</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">E</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>err<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">E</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">E</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只在ready=false时进行以下操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果发生错误，代表还是未准备好</span>
    ready <span class="token operator">=</span> <span class="token operator">!</span>err
    <span class="token comment">// 设置监听器</span>
    <span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 执行ready回调</span>
    readyHandlers
      <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 重置ready回调列表</span>
    readyHandlers<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>markAsReady</code>函数会标记路由的准备状态，执行通过<code>isReady</code>添加的回调。</p> <p>所以完善下路由导航的解析</p> <div class="language-tex line-numbers-mode"><pre class="language-tex"><code>1. 导航被触发
2. 调用失活组件的beforeRouteLeave
3. 调用全局的beforeEach
4. 复用组件的beforeRouteUpdate
5. 路由配置中beforeEnter
6. 解析异步路由组件
7. 组件的beforeRouteEnter
8. 全局钩子beforeResolve
9. 导航确认
10. 调用全局的afterEach钩子
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_2-replace"><a href="#_2-replace" class="header-anchor">#</a> 2. replace</h2> <p><code>replace</code>与<code>push</code>作用几乎相同，如果<code>push</code>时指定<code>replace: true</code>，那么和直接使用<code>replace</code>一致。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationRaw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里调用了一个<code>locationAsObject</code>，如果<code>to</code>是<code>string</code>，会调用<code>parseURL</code>解析<code>to</code>，关于<code>parseURL</code>的实现可参考之前<code>router.resolve</code>的分析，它的主要作用是将<code>to</code>解析成一个含有<code>fullPath（fullPath = path + searchString + hash）、path（一个绝对路径）、query（query对象）、hash（#及#之后的字符串）</code>的对象。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">locationAsObject</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocationNormalized
<span class="token punctuation">)</span><span class="token operator">:</span> Exclude<span class="token operator">&lt;</span>RouteLocationRaw<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">|</span> RouteLocationNormalized <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span>
    <span class="token operator">?</span> <span class="token function">parseURL</span><span class="token punctuation">(</span>parseQuery<span class="token punctuation">,</span> to<span class="token punctuation">,</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间: </span> <span class="time">6/9/2023, 4:06:17 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/my-blog/blogs/source/vue-router/matcher.html" class="prev">
          vue-router 第二篇
        </a></span> <span class="next"><a href="/my-blog/blogs/source/vue-router/routerGuard.html">
          vue-router 第五篇
        </a></span></p></div> <div class="comments-wrapper" style="display:none;"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/my-blog/blogs/source/vue-router/push.html#_1-push" class="sidebar-link reco-side-_1-push" data-v-b57cc07c>1. push</a></li><li class="level-3" data-v-b57cc07c><a href="/my-blog/blogs/source/vue-router/push.html#pushwithredirect" class="sidebar-link reco-side-pushwithredirect" data-v-b57cc07c>pushWithRedirect</a></li><li class="level-3" data-v-b57cc07c><a href="/my-blog/blogs/source/vue-router/push.html#handleredirectrecord" class="sidebar-link reco-side-handleredirectrecord" data-v-b57cc07c>handleRedirectRecord</a></li><li class="level-3" data-v-b57cc07c><a href="/my-blog/blogs/source/vue-router/push.html#跳转路由和当前路由同一的处理" class="sidebar-link reco-side-跳转路由和当前路由同一的处理" data-v-b57cc07c>跳转路由和当前路由同一的处理</a></li><li class="level-3" data-v-b57cc07c><a href="/my-blog/blogs/source/vue-router/push.html#handlescroll" class="sidebar-link reco-side-handlescroll" data-v-b57cc07c>handleScroll</a></li><li class="level-2" data-v-b57cc07c><a href="/my-blog/blogs/source/vue-router/push.html#_2-replace" class="sidebar-link reco-side-_2-replace" data-v-b57cc07c>2. replace</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/my-blog/assets/js/app.32be202e.js" defer></script><script src="/my-blog/assets/js/3.a0eaa787.js" defer></script><script src="/my-blog/assets/js/1.f46f4f66.js" defer></script><script src="/my-blog/assets/js/80.5d5f4b1e.js" defer></script>
  </body>
</html>
